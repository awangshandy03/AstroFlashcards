<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astronomy Flashcards</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .screen {
            display: none;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
            position: relative; /* For overlay positioning */
        }
        .active {
            display: block;
        }
        .btn-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        .btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            text-align: center;
        }
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #2980b9, #9b59b6);
        }
        .btn:active {
            transform: translateY(0);
        }
        .gamemode-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        .gamemode-btn:hover {
            background: linear-gradient(45deg, #219653, #27ae60);
        }
        .back-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            margin-top: 20px;
        }
        .back-btn:hover {
            background: linear-gradient(45deg, #c0392b, #a5281b);
        }
        .flashcard {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative; /* For overlay positioning */
        }
        .flashcard img {
            max-width: 100%;
            max-height: 500px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        .flashcard h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }
        .option-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            word-break: break-word; /* Handle long names */
        }
        .option-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
        }
        .option-btn.correct {
            background: rgba(46, 204, 113, 0.7);
            border-color: #2ecc71;
        }
        .option-btn.incorrect {
            background: rgba(231, 76, 60, 0.7);
            border-color: #e74c3c;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .control-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .stats {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2rem;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .timer-display {
            text-align: center;
            font-size: 1.5rem;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .timer-warning {
            color: #e74c3c;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .settings {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .setting-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
        }
        .setting-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        .setting-item input[type="number"] {
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            width: 80px;
        }
        .setting-item label {
            font-size: 1.1rem;
            flex-grow: 1;
        }
        .result-screen {
            text-align: center;
        }
        .result-stats {
            font-size: 1.5rem;
            margin: 20px 0;
        }
        .progress-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .question-counter {
            text-align: center;
            font-size: 1.2rem;
            margin: 10px 0;
        }
        
        /* New styles for typing mode */
        .typing-container {
            width: 100%;
            margin: 20px 0;
        }
        .typing-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
        }
        .typing-input:focus {
            outline: none;
            border-color: #3498db;
        }
        .answer-lists {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 20px;
            gap: 20px;
        }
        .answer-list {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            flex: 1;
        }
        .answer-list h3 {
            text-align: center;
            margin-bottom: 10px;
        }
        .answer-items {
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
        }
        .answer-item {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .submit-btn, .skip-btn {
            margin-top: 15px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            margin-right: 10px;
        }
        .submit-btn {
            background: rgba(52, 152, 219, 0.7);
        }
        .submit-btn:hover {
            background: rgba(52, 152, 219, 1);
        }
        .skip-btn {
            background: rgba(155, 89, 182, 0.7);
        }
        .skip-btn:hover {
            background: rgba(155, 89, 182, 1);
        }
        .skip-btn:disabled, .submit-btn:disabled {
            background: rgba(128, 128, 128, 0.5);
            cursor: not-allowed;
        }

        /* Overlay for skipped answers */
        .skip-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            text-align: center;
            min-width: 300px;
            max-width: 80%;
        }
        .skip-overlay h3 {
            margin-bottom: 15px;
            color: #e74c3c;
        }
        .skip-overlay-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .skip-overlay-list li {
            padding: 8px;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .btn-container {
                flex-direction: column;
                align-items: center;
            }
            .btn {
                width: 100%;
                max-width: 300px;
            }
            .options-container {
                grid-template-columns: 1fr;
            }
            .answer-lists {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🌌 Astronomy Flashcards</h1>
            <p class="subtitle">Test your knowledge of constellations and Messier objects</p>
        </header>
        <!-- Main Menu Screen -->
        <div id="main-menu" class="screen active">
            <h2>Choose Category</h2>
            <div class="btn-container">
                <button class="btn" onclick="selectCategory('constellation')">Constellations</button>
                <button class="btn" onclick="selectCategory('messier')">Messier Objects</button>
            </div>
        </div>
        <!-- Category Menu Screen -->
        <div id="category-menu" class="screen">
            <h2 id="category-title">Choose Gamemode</h2>
            <div class="btn-container" id="gamemode-buttons">
                <!-- Gamemode buttons will be added here dynamically -->
            </div>
            <button class="btn back-btn" onclick="showScreen('main-menu')">← Back</button>
        </div>
        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <h2>Game Settings</h2>
            <div class="settings">
                <div class="setting-item">
                    <input type="checkbox" id="round-timer-checkbox">
                    <label for="round-timer-checkbox">Round Timer (minutes):</label>
                    <input type="number" id="round-timer-value" min="1" max="60" value="5">
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="question-timer-checkbox">
                    <label for="question-timer-checkbox">Question Timer (seconds):</label>
                    <input type="number" id="question-timer-value" min="5" max="120" value="30">
                </div>
                <div class="setting-item">
                    <label for="question-count">Questions per round:</label>
                    <input type="number" id="question-count" min="5" max="110" value="20">
                </div>
            </div>
            <button class="btn" onclick="startGame()">Start Game</button>
            <button class="btn back-btn" onclick="showScreen('category-menu')">← Back</button>
        </div>
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="stats">
                <div class="stat-item">
                    <div>Correct</div>
                    <div class="stat-value" id="correct-count">0</div>
                </div>
                <div class="stat-item">
                    <div>Incorrect</div>
                    <div class="stat-value" id="incorrect-count">0</div>
                </div>
                <div class="stat-item">
                    <div>Score</div>
                    <div class="stat-value" id="score">0%</div>
                </div>
            </div>
            <div class="question-counter">
                Question <span id="current-question">1</span> of <span id="total-questions">10</span>
            </div>
            <div class="progress-bar">
                <div class="progress" id="progress-bar" style="width: 10%"></div>
            </div>
            <div class="timer-display" id="timer-display">
                Time Remaining: <span id="time-remaining">30s</span>
            </div>
            <div class="flashcard">
                <h2 id="question-text">Question will appear here</h2>
                <img id="question-image" src="" alt="Astronomy Image" style="display: none;">
                <!-- Typing input for new gamemode -->
                <div id="typing-container" class="typing-container" style="display: none;">
                    <input type="text" id="typing-input" class="typing-input" placeholder="Type Messier number (e.g., 1, 31, 42)">
                    <button id="submit-btn" class="submit-btn" onclick="submitTypedAnswer()">Submit (Enter)</button>
                    <button id="skip-btn" class="skip-btn" onclick="skipTypingQuestion()">Skip</button>
                </div>
                <!-- Lists for correct/incorrect answers in typing mode -->
                <div id="answer-lists" class="answer-lists" style="display: none;">
                    <div class="answer-list">
                        <h3>✅ Correct</h3>
                        <div id="correct-answers" class="answer-items"></div>
                    </div>
                    <div class="answer-list">
                        <h3>❌ Incorrect</h3>
                        <div id="incorrect-answers" class="answer-items"></div>
                    </div>
                </div>
                <!-- Overlay for skipped answers -->
                <div id="skip-overlay" class="skip-overlay" style="display: none;"></div>
            </div>
            <div class="options-container" id="options-container">
                <!-- Options will be added here dynamically -->
            </div>
            <div class="controls">
                <button class="control-btn" id="shuffle-btn" onclick="shuffleQuestions()">🔀 Shuffle</button>
                <button class="control-btn" onclick="showScreen('settings-screen')">⚙️ Settings</button>
            </div>
        </div>
        <!-- Result Screen -->
        <div id="result-screen" class="screen">
            <div class="result-screen">
                <h2>Game Completed!</h2>
                <div class="result-stats">
                    <p>Correct Answers: <span id="final-correct">0</span></p>
                    <p>Incorrect Answers: <span id="final-incorrect">0</span></p>
                    <p>Final Score: <span id="final-score">0%</span></p>
                </div>
                <button class="btn" onclick="restartGame()">Restart Game</button>
                <button class="btn back-btn" onclick="showScreen('main-menu')">Main Menu</button>
            </div>
        </div>
    </div>
    <script>
        // Global variables
        let currentCategory = '';
        let currentGamemode = '';
        let questions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        let roundTimer = null;
        let questionTimer = null;
        let roundTimeRemaining = 0;
        let questionTimeRemaining = 0;
        let roundTimerEnabled = false;
        let questionTimerEnabled = false;
        
        // For typing mode
        let currentTypedAnswers = { correct: new Set(), incorrect: new Set() };
        let currentConstellationMessiers = []; // Stores Messier numbers for the current constellation question
        
        // Full constellation data with abbreviations and brightest stars
        // FIXED: Ensured constellations is a single, continuous array
        const constellations = [
            { code: 'AND', name: 'Andromeda', brightest: ['Alpheratz', 'Mirach', 'Almach'] },
            { code: 'ANT', name: 'Antlia', brightest: ['Alpha Antliae'] },
            { code: 'APS', name: 'Apus', brightest: ['Alpha Apodis'] },
            { code: 'AQR', name: 'Aquarius', brightest: ['Sadalmelik', 'Sadalsuud'] },
            { code: 'AQL', name: 'Aquila', brightest: ['Altair','Alshain','Tarazed'] },
            { code: 'ARA', name: 'Ara', brightest: ['Alpha Arae'] },
            { code: 'ARI', name: 'Aries', brightest: ['hammal', 'Sheratan', 'Mesartim'] },
            { code: 'AUR', name: 'Auriga', brightest: ['Capella', 'Menkalinan'] },
            { code: 'BOO', name: 'Boötes', brightest: ['Arcturus', 'Nekkar', 'Seginus'] },
            { code: 'CAE', name: 'Caelum', brightest: ['Alpha Caeli'] },
            { code: 'CAM', name: 'Camelopardalis', brightest: ['Alpha Camelopardalis'] },
            { code: 'CNC', name: 'Cancer', brightest: ['Acubens','Tarf','Asellus Borealis']},
            { code: 'CVN', name: 'Canes Venatici', brightest: ['Cor Caroli', 'Chara'] },
            { code: 'CMA', name: 'Canis Major', brightest: ['Sirius', 'Mirzam', 'Muliphein', 'Wezen'] },
            { code: 'CMI', name: 'Canis Minor', brightest: ['Procyon', 'Gomeisha'] },
            { code: 'CAP', name: 'Capricornus', brightest: ['Algedi', 'Dabih', 'Nashira', 'Deneb Algedi'] },
            { code: 'CAR', name: 'Carina', brightest: ['Canopus', 'Miaplacidus'] },
            { code: 'CAS', name: 'Cassiopeia', brightest: ['Schedar', 'Caph'] },
            { code: 'CEN', name: 'Centaurus', brightest: ['Rigil Kentaurus', 'Hadar'] },
            { code: 'CEP', name: 'Cepheus', brightest: ['Alderamin', 'Alfirk', 'Errai'] },
            { code: 'CET', name: 'Cetus', brightest: ['Menkar', 'Deneb Kaitos'] },
            { code: 'CHA', name: 'Chamaeleon', brightest: ['Alpha Chamaeleontis'] },
            { code: 'CIR', name: 'Circinus', brightest: ['Alpha Circini'] },
            { code: 'COL', name: 'Columba', brightest: ['Phact', 'Wazn'] },
            { code: 'COM', name: 'Coma Berenices', brightest: ['Diadem'] },
            { code: 'CRA', name: 'Corona Australis', brightest: ['Meridiana'] },
            { code: 'CRB', name: 'Corona Borealis', brightest: ['Alphecca', 'Nusakan'] },
            { code: 'CRV', name: 'Corvus', brightest: ['Alchiba', 'Kraz', 'Gienah', 'Algorab'] },
            { code: 'CRT', name: 'Crater', brightest: ['Alkes'] },
            { code: 'CRU', name: 'Crux', brightest: ['Acrux', 'Mimosa', 'Gacrux','Imai'] },
            { code: 'CYG', name: 'Cygnus', brightest: ['Deneb', 'Albireo', 'Sadr', 'Fawaris'] },
            { code: 'DEL', name: 'Delphinus', brightest: ['Sualocin', 'Rotanev'] },
            { code: 'DOR', name: 'Dorado', brightest: ['Alpha Doradus'] },
            { code: 'DRA', name: 'Draco', brightest: ['Thuban', 'Rastaban', 'Eltanin', 'Altais'] },
            { code: 'EQU', name: 'Equuleus', brightest: ['Kitalpha'] },
            { code: 'ERI', name: 'Eridanus', brightest: ['Achernar', 'Cursa', 'Zaurak'] },
            { code: 'FOR', name: 'Fornax', brightest: ['Dalim'] },
            { code: 'GEM', name: 'Gemini', brightest: ['Castor', 'Pollux', 'Alhena','Wasat'] },
            { code: 'GRU', name: 'Grus', brightest: ['Alnair', 'Tiaki', 'Aldhanab'] },
            { code: "HER", name: "Hercules", brightest: ["Rasalgethi", "Kornephoros"] },
            { code: "HOR", name: "Horologium", brightest: [] },
            { code: "HYA", name: "Hydra", brightest: ["Alphard"] },
            { code: "HYI", name: "Hydrus", brightest: [] },
            { code: "IND", name: "Indus", brightest: [] },
            { code: "LAC", name: "Lacerta", brightest: [] },
            { code: "LEO", name: "Leo", brightest: ["Regulus", "Denebola", "Algieba", "Zosma", "Chertan"] },
            { code: "LMI", name: "Leo Minor", brightest: ["Praecipua"] },
            { code: "LEP", name: "Lepus", brightest: ["Arneb", "Nihal"] },
            { code: "LIB", name: "Libra", brightest: ["Zubenelgenubi", "Zubeneschamali"] },
            { code: "LUP", name: "Lupus", brightest: [] },
            { code: "LYN", name: "Lynx", brightest: [] },
            { code: "LYR", name: "Lyra", brightest: ["Vega", "Sheliak", "Sulafat"] },
            { code: "MEN", name: "Mensa", brightest: [] },
            { code: "MIC", name: "Microscopium", brightest: [] },
            { code: "MON", name: "Monoceros", brightest: [] },
            { code: "MUS", name: "Musca", brightest: [] },
            { code: "NOR", name: "Norma", brightest: [] },
            { code: "OCT", name: "Octans", brightest: [] },
            { code: "OPH", name: "Ophiuchus", brightest: ["Rasalhague", "Cebalrai", "Sabik"] },
            { code: "ORI", name: "Orion", brightest: ["Betelgeuse", "Rigel", "Bellatrix", "Mintaka", "Alnilam", "Alnitak", "Saiph"] },
            { code: "PAV", name: "Pavo", brightest: ["Peacock"] },
            { code: "PEG", name: "Pegasus", brightest: ["Markab", "Scheat", "Algenib", "Enif"] },
            { code: "PER", name: "Perseus", brightest: ["Mirfak", "Algol"] },
            { code: "PHE", name: "Phoenix", brightest: ["Ankaa"] },
            { code: "PIC", name: "Pictor", brightest: [] },
            { code: "PSC", name: "Pisces", brightest: ["Alpherg"] },
            { code: "PSA", name: "Piscis Austrinus", brightest: ["Fomalhaut"] },
            { code: "PUP", name: "Puppis", brightest: ["Naos", "Turais"] },
            { code: "PYX", name: "Pyxis", brightest: [] },
            { code: "RET", name: "Reticulum", brightest: [] },
            { code: "SGE", name: "Sagitta", brightest: [] },
            { code: "SGR", name: "Sagittarius", brightest: ["Rukbat", "Arkab", "Alnasl", "Kaus Media", "Kaus Australis", "Kaus Borealis", "Nunki"] },
            { code: "SCO", name: "Scorpius", brightest: ["Antares", "Shaula", "Sargas", "Dschubba", "Acrab"] },
            { code: "SCL", name: "Sculptor", brightest: [] },
            { code: "SCT", name: "Scutum", brightest: [] },
            { code: "SER", name: "Serpens", brightest: ["Unukalhai"] },
            { code: "SEX", name: "Sextans", brightest: [] },
            { code: "TAU", name: "Taurus", brightest: ["Aldebaran", "El Nath"] },
            { code: "TEL", name: "Telescopium", brightest: [] },
            { code: "TRI", name: "Triangulum", brightest: ["Mothallah"] },
            { code: "TRA", name: "Triangulum Australe", brightest: ["Atria"] },
            { code: "TUC", name: "Tucana", brightest: [] },
            { code: "UMA", name: "Ursa Major", brightest: ["Dubhe", "Merak", "Phecda", "Megrez", "Alioth", "Mizar", "Alkaid"] },
            { code: "UMI", name: "Ursa Minor", brightest: ["Polaris", "Kochab", "Pherkad"] },
            { code: "VEL", name: "Vela", brightest: ["Regor", "Suhail", "Markeb"] },
            { code: "VIR", name: "Virgo", brightest: ["Spica", "Porrima", "Vindemiatrix"] },
            { code: "VOL", name: "Volans", brightest: [] },
            { code: "VUL", name: "Vulpecula", brightest: ["Anser"] }
        ];
        
        // Full Messier objects data (M1-M110)
        // FIXED: Ensured messierObjects is a single, continuous array
        const messierObjects = [
            { code: "M001", name: "Crab Supernova Remnant Nebula", constellation: "Taurus" },
            { code: "M002", name: "NGC 7089 Globular Cluster", constellation: "Aquarius" },
            { code: "M003", name: "NGC 5272 Globular Cluster", constellation: "Canes Venatici" },
            { code: "M004", name: "Spider Globular Cluster", constellation: "Scorpius" },
            { code: "M005", name: "NGC 5904 Globular Cluster", constellation: "Serpens" },
            { code: "M006", name: "Butterfly Open Cluster", constellation: "Scorpius" },
            { code: "M007", name: "Ptolemy Open Cluster", constellation: "Scorpius" },
            { code: "M008", name: "Lagoon Emission Nebula", constellation: "Sagittarius" },
            { code: "M009", name: "NGC 6333 Globular Cluster", constellation: "Ophiuchus" },
            { code: "M010", name: "NGC 6254 Globular Cluster", constellation: "Ophiuchus" },
            { code: "M011", name: "Wild Duck Open Cluster", constellation: "Scutum" },
            { code: "M012", name: "NGC 6218 Globular Cluster", constellation: "Ophiuchus" },
            { code: "M013", name: "Hercules Globular Cluster", constellation: "Hercules" },
            { code: "M014", name: "NGC 6402 Globular Cluster", constellation: "Ophiuchus" },
            { code: "M015", name: "Great Pegasus Globular Cluster", constellation: "Pegasus" },
            { code: "M016", name: "Eagle Emission Nebula", constellation: "Serpens" },
            { code: "M017", name: "Omega Emission Nebula", constellation: "Sagittarius" },
            { code: "M018", name: "Black Swan Open Cluster", constellation: "Sagittarius" },
            { code: "M019", name: "NGC 6273 Globular Cluster", constellation: "Ophiuchus" },
            { code: "M020", name: "Trifid Emission Nebula", constellation: "Sagittarius" },
            { code: "M021", name: "Webbs Cross Open Cluster", constellation: "Sagittarius" },
            { code: "M022", name: "Great Sagittarius Globular Cluster", constellation: "Sagittarius" },
            { code: "M023", name: "NGC 6494 Open Cluster", constellation: "Sagittarius" },
            { code: "M024", name: "Small Sagittarius Star Cloud", constellation: "Sagittarius" },
            { code: "M025", name: "IC 4725 Open Cluster", constellation: "Sagittarius" },
            { code: "M026", name: "NGC 6694 Open Cluster", constellation: "Scutum" },
            { code: "M027", name: "Dumbbell Planetary Nebula", constellation: "Vulpecula" },
            { code: "M028", name: "NGC 6626 Globular Cluster", constellation: "Sagittarius" },
            { code: "M029", name: "Cooling Tower Open Cluster", constellation: "Cygnus" },
            { code: "M030", name: "Jellyfish Globular Cluster", constellation: "Capricornus" },
            { code: "M031", name: "Andromeda Spiral Galaxy", constellation: "Andromeda" },
            { code: "M032", name: "Le Gentil Elliptical Galaxy", constellation: "Andromeda" },
            { code: "M033", name: "Triangulum Spiral Galaxy", constellation: "Triangulum" },
            { code: "M034", name: "Spiral Open Cluster", constellation: "Perseus" },
            { code: "M035", name: "Shoe-Buckle Open Cluster", constellation: "Gemini" },
            { code: "M036", name: "Pinwheel Open Cluster", constellation: "Auriga" },
            { code: "M037", name: "Salt-and-Pepper Open Cluster", constellation: "Auriga" },
            { code: "M038", name: "Starfish Open Cluster", constellation: "Auriga" },
            { code: "M039", name: "Pyramid Open Cluster", constellation: "Cygnus" },
            { code: "M040", name: "Winnecke 4 Double Star", constellation: "Ursa Major" },
            { code: "M041", name: "Little Beehive Open Cluster", constellation: "Canis Major" },
            { code: "M042", name: "Orion Emission Nebula", constellation: "Orion" },
            { code: "M043", name: "De Mairan's Emission Nebula", constellation: "Orion" },
            { code: "M044", name: "Beehive Open Cluster", constellation: "Cancer" },
            { code: "M045", name: "Pleiades Open Cluster", constellation: "Taurus" },
            { code: "M046", name: "NGC 2437 Open Cluster", constellation: "Puppis" },
            { code: "M047", name: "NGC 2422 Open Cluster", constellation: "Puppis" },
            { code: "M048", name: "NGC 2548 Open Cluster", constellation: "Hydra" },
            { code: "M049", name: "NGC 4472 Elliptical Galaxy", constellation: "Virgo" },
            { code: "M050", name: "Heart-Shaped Open Cluster", constellation: "Monoceros" },
            { code: "M051", name: "Whirlpool Spiral Galaxy", constellation: "Canes Venatici" },
            { code: "M052", name: "Scorpion Open Cluster", constellation: "Cassiopeia" },
            { code: "M053", name: "NGC 5024 Globular Cluster", constellation: "Coma Berenices" },
            { code: "M054", name: "NGC 6715 Globular Cluster", constellation: "Sagittarius" },
            { code: "M055", name: "Summer Rose Star Globular Cluster", constellation: "Sagittarius" },
            { code: "M056", name: "NGC 6679 Globular Cluster", constellation: "Lyra" },
            { code: "M057", name: "Ring Planetary Nebula", constellation: "Lyra" },
            { code: "M058", name: "NGC 4579 Barred Spiral Galaxy", constellation: "Virgo" },
            { code: "M059", name: "NGC 4621 Elliptical Galaxy", constellation: "Virgo" },
            { code: "M060", name: "NGC 4649 Elliptical Galaxy", constellation: "Virgo" },
            { code: "M061", name: "Swelling Spiral Galaxy", constellation: "Virgo" },
            { code: "M062", name: "Flickering Globular Cluster", constellation: "Ophiuchus" },
            { code: "M063", name: "Sunflower Spiral Galaxy", constellation: "Canes Venatici" },
            { code: "M064", name: "Black Eye Spiral Galaxy", constellation: "Coma Berenices" },
            { code: "M065", name: "Leo Triplet Spiral Galaxy", constellation: "Leo" },
            { code: "M066", name: "Leo Triplet 2 Spiral Galaxy", constellation: "Leo" },
            { code: "M067", name: "King Cobra Open Cluster", constellation: "Cancer" },
            { code: "M068", name: "NGC 4590 Globular Cluster", constellation: "Hydra" },
            { code: "M069", name: "NGC 6637 Globular Cluster", constellation: "Sagittarius" },
            { code: "M070", name: "NGC 6681 Globular Cluster", constellation: "Sagittarius" },
            { code: "M071", name: "Angelfish Globular Cluster", constellation: "Sagitta" },
            { code: "M072", name: "NGC 6981 Globular Cluster", constellation: "Aquarius" },
            { code: "M073", name: "NGC 6994 Asterism", constellation: "Aquarius" },
            { code: "M074", name: "Phantom Spiral Galaxy", constellation: "Pisces" },
            { code: "M075", name: "NGC 6864 Globular Cluster", constellation: "Sagittarius" },
            { code: "M076", name: "Little Dumbbell Planetary Nebula", constellation: "Perseus" },
            { code: "M077", name: "Cetus A Barred Spiral Galaxy", constellation: "Cetus" },
            { code: "M078", name: "NGC 2068 Reflection Nebula", constellation: "Orion" },
            { code: "M079", name: "NGC 1904 Globular Cluster", constellation: "Lepus" },
            { code: "M080", name: "NGC 6093 Globular Cluster", constellation: "Scorpius" },
            { code: "M081", name: "Bode's Spiral Galaxy", constellation: "Ursa Major" },
            { code: "M082", name: "Cigar Irregular Galaxy", constellation: "Ursa Major" },
            { code: "M083", name: "Southern Pinwheel Barred Spiral Galaxy", constellation: "Hydra" },
            { code: "M084", name: "NGC 4374 Lenticular Galaxy", constellation: "Virgo" },
            { code: "M085", name: "NGC 4382 Lenticular Galaxy", constellation: "Coma Berenices" },
            { code: "M086", name: "NGC 4406 Lenticular Galaxy", constellation: "Virgo" },
            { code: "M087", name: "Virgo A Elliptical Galaxy", constellation: "Virgo" },
            { code: "M088", name: "NGC 4501 Spiral Galaxy", constellation: "Coma Berenices" },
            { code: "M089", name: "NGC 4552 Elliptical Galaxy", constellation: "Virgo" },
            { code: "M090", name: "NGC 4569 Spiral Galaxy", constellation: "Virgo" },
            { code: "M091", name: "NGC 4548 Barred Spiral Galaxy", constellation: "Coma Berenices" },
            { code: "M092", name: "NGC 6341 Globular Cluster", constellation: "Hercules" },
            { code: "M093", name: "NGC 2447 Open Cluster", constellation: "Puppis" },
            { code: "M094", name: "Croc's Eye Spiral Galaxy", constellation: "Canes Venatici" },
            { code: "M095", name: "NGC 3351 Barred Spiral Galaxy", constellation: "Leo" },
            { code: "M096", name: "NGC 3386 Spiral Galaxy", constellation: "Leo" },
            { code: "M097", name: "Owl Planetary Nebula", constellation: "Ursa Major" },
            { code: "M098", name: "NGC 4192 Spiral Galaxy", constellation: "Coma Berenices" },
            { code: "M099", name: "Coma Pinwheel Spiral Galaxy", constellation: "Coma Berenices" },
            { code: "M100", name: "Blowdryer Spiral Galaxy", constellation: "Coma Berenices" },
            { code: "M101", name: "Pinwheel Spiral Galaxy", constellation: "Ursa Major" },
            { code: "M102", name: "Spindle Lenticular Galaxy", constellation: "Draco" },
            { code: "M103", name: "NGC 581 Open Cluster", constellation: "Cassiopeia" },
            { code: "M104", name: "Sombrero Spiral Galaxy", constellation: "Virgo" },
            { code: "M105", name: "NGC 3379 Elliptical Galaxy", constellation: "Leo" },
            { code: "M106", name: "NGC 4258 Spiral Galaxy", constellation: "Canes Venatici" },
            { code: "M107", name: "Crucifix Globular Cluster", constellation: "Ophiuchus" },
            { code: "M108", name: "Surfboard Spiral Galaxy", constellation: "Ursa Major" },
            { code: "M109", name: "Vacuum Cleaner Barred Spiral Galaxy", constellation: "Ursa Major" },
            { code: "M110", name: "Edward Young Star Elliptical Galaxy", constellation: "Andromeda" }
        ];
        
        // Gamemode definitions
        const gamemodes = {
            constellation: [
                { id: 'constellation-name', name: 'Constellation → Name', description: 'Identify the constellation from its image' },
                { id: 'brightest-star', name: 'Brightest Star', description: 'Identify the n-th brightest star in a constellation' },
                { id: 'constellation-messier-typing', name: 'Constellation → Messier (Typing)', description: 'Type Messier numbers for a given constellation' }
            ],
            messier: [
                { id: 'messier-location', name: 'Location → Codename', description: 'Identify Messier object from its location' },
                { id: 'messier-constellation', name: 'Codename → Location', description: 'Match Messier object to its constellation' },
                { id: 'messier-name', name: 'Codename → Common Name', description: 'Identify common name of Messier objects' }
            ]
        };
        // Show a specific screen
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            // Show the requested screen
            document.getElementById(screenId).classList.add('active');
        }
        // Select category and show gamemodes
        function selectCategory(category) {
            currentCategory = category;
            document.getElementById('category-title').textContent = 
                category === 'constellation' ? 'Constellation Gamemodes' : 'Messier Gamemodes';
            const gamemodeButtons = document.getElementById('gamemode-buttons');
            gamemodeButtons.innerHTML = '';
            gamemodes[category].forEach(mode => {
                const button = document.createElement('button');
                button.className = 'btn gamemode-btn';
                button.textContent = mode.name;
                button.onclick = () => selectGamemode(mode.id);
                gamemodeButtons.appendChild(button);
            });
            showScreen('category-menu');
        }
        // Select gamemode and go to settings
        function selectGamemode(gamemode) {
            currentGamemode = gamemode;
            showScreen('settings-screen');
        }
        // Start the game
        function startGame() {
            // Get timer settings
            roundTimerEnabled = document.getElementById('round-timer-checkbox').checked;
            questionTimerEnabled = document.getElementById('question-timer-checkbox').checked;
            const roundMinutes = parseInt(document.getElementById('round-timer-value').value) || 5;
            const questionSeconds = parseInt(document.getElementById('question-timer-value').value) || 30;
            roundTimeRemaining = roundMinutes * 60;
            questionTimeRemaining = questionSeconds;
            // Generate questions based on category and gamemode
            generateQuestions();
            // Reset game stats
            correctCount = 0;
            incorrectCount = 0;
            currentQuestionIndex = 0;
            // Update UI
            updateStats();
            document.getElementById('total-questions').textContent = questions.length;
            // Start timers if enabled
            if (roundTimerEnabled) {
                startRoundTimer();
            }
            // Show first question
            showQuestion();
            // Show game screen
            showScreen('game-screen');
        }
        // Generate questions based on current category and gamemode
        function generateQuestions() {
            questions = [];
            // Get question count from user input
            const questionCountInput = parseInt(document.getElementById('question-count').value) || 20;
            const maxQuestions = currentCategory === 'constellation' ? constellations.length : messierObjects.length;
            const numQuestions = Math.min(questionCountInput, maxQuestions);
            if (currentCategory === 'constellation') {
                // For brightest-star mode, filter out constellations with no brightest stars
                const shuffledConstellations = [...constellations].sort(() => Math.random() - 0.5);
                const constellationPool = currentGamemode === 'brightest-star' 
                    ? shuffledConstellations.filter(c => c.brightest.length > 0)
                    : shuffledConstellations;
                // Adjust numQuestions if we're in brightest-star mode and have fewer valid constellations
                const actualNumQuestions = currentGamemode === 'brightest-star' 
                    ? Math.min(numQuestions, constellationPool.length)
                    : numQuestions;
                    
                // For typing mode, we need constellations that have Messier objects
                const typingConstellationPool = currentGamemode === 'constellation-messier-typing' 
                    ? shuffledConstellations.filter(c => 
                        messierObjects.some(m => m.constellation === c.name)
                      )
                    : shuffledConstellations;
                const typingActualNumQuestions = currentGamemode === 'constellation-messier-typing' 
                    ? Math.min(numQuestions, typingConstellationPool.length)
                    : numQuestions;
                
                for (let i = 0; i < (
                    currentGamemode === 'constellation-messier-typing' ? 
                    typingActualNumQuestions : 
                    (currentGamemode === 'brightest-star' ? actualNumQuestions : numQuestions)
                ); i++) {
                    const constellation = 
                        currentGamemode === 'constellation-messier-typing' ? 
                        typingConstellationPool[i % typingConstellationPool.length] :
                        (currentGamemode === 'brightest-star' ? 
                         constellationPool[i % constellationPool.length] :
                         shuffledConstellations[i % shuffledConstellations.length]);
                         
                    if (currentGamemode === 'constellation-name') {
                        questions.push({
                            type: 'image-to-name',
                            image: `image/cons/${constellation.code}.png`,
                            correctAnswer: constellation.name,
                            allOptions: constellations.map(c => c.name) // Fixed: Added missing options
                        });
                    } else if (currentGamemode === 'brightest-star') {
                        // Get a random star from the brightest list (1st to 5th)
                        const starIndex = Math.floor(Math.random() * Math.min(5, constellation.brightest.length));
                        const starRank = ['1st', '2nd', '3rd', '4th', '5th'][starIndex];
                        questions.push({
                            type: 'constellation-to-star',
                            image: `image/cons/${constellation.code}.png`,
                            question: `What is the ${starRank} brightest star in ${constellation.name}?`,
                            correctAnswer: constellation.brightest[starIndex],
                            allOptions: constellation.brightest.concat(
                                constellations.flatMap(c => c.brightest)
                            ).filter((_, index) => index < 20) // Limit options
                        });
                    } else if (currentGamemode === 'constellation-messier-typing') {
                        // Get all Messier objects for this constellation
                        const messiersForConstellation = messierObjects
                            .filter(m => m.constellation === constellation.name)
                            .map(m => parseInt(m.code.replace('M', ''), 10).toString()); // Extract just the number without leading zeros
                        
                        questions.push({
                            type: 'constellation-to-messier-typing',
                            question: `Type Messier numbers for ${constellation.name}:`,
                            constellationName: constellation.name,
                            correctAnswers: messiersForConstellation, // Array of correct Messier numbers
                            allOptions: [] // Not used for typing mode
                        });
                    }
                }
            } else if (currentCategory === 'messier') {
                // Shuffle Messier objects
                const shuffledMessier = [...messierObjects].sort(() => Math.random() - 0.5);
                for (let i = 0; i < numQuestions; i++) {
                    const messier = shuffledMessier[i % shuffledMessier.length];
                    if (currentGamemode === 'messier-location') {
                        questions.push({
                            type: 'image-to-code',
                            image: `image/messier/${messier.code}.png`,
                            correctAnswer: messier.code,
                            allOptions: messierObjects.map(m => m.code) // Fixed: Added missing options
                        });
                    } else if (currentGamemode === 'messier-constellation') {
                        const allConstellations = [...new Set(messierObjects.map(m => m.constellation))];
                        questions.push({
                            type: 'code-to-constellation',
                            question: messier.code,
                            correctAnswer: messier.constellation,
                            allOptions: allConstellations
                        });
                    } else if (currentGamemode === 'messier-name') {
                        questions.push({
                            type: 'code-to-name',
                            question: messier.code,
                            correctAnswer: messier.name,
                            allOptions: messierObjects.map(m => m.name)
                        });
                    }
                }
            }
            // Shuffle questions
            shuffleArray(questions);
        }
        // Show current question
        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame();
                return;
            }
            const question = questions[currentQuestionIndex];
            const questionText = document.getElementById('question-text');
            const questionImage = document.getElementById('question-image');
            const typingContainer = document.getElementById('typing-container');
            const answerLists = document.getElementById('answer-lists');
            const optionsContainer = document.getElementById('options-container');
            const skipOverlay = document.getElementById('skip-overlay'); // If used elsewhere, make sure it's declared

            // Reset option styles
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('correct', 'incorrect');
            });

            // Hide all question elements by default
            questionImage.style.display = 'none';
            typingContainer.style.display = 'none';
            answerLists.style.display = 'none';
            optionsContainer.innerHTML = ''; // Clear options
            // Assuming skipOverlay is hidden by default in CSS or handled elsewhere
            // skipOverlay.style.display = 'none';

            // Set question text - Fix: Initialize correctly
            // For image questions, question.question is undefined, so don't set it yet
            // For text questions, question.question will be used
            // We'll set it specifically in the branches below
            questionText.textContent = ''; // Start with empty text

            // Handle different question types
            if (question.type.includes('image')) {
                questionImage.src = question.image;
                questionImage.style.display = 'block';
                // Explicitly clear text for image questions (like old version)
                questionText.textContent = '';
                // Options will be generated in the final 'else' block below (for non-typing image questions)
            } else if (question.type === 'constellation-to-messier-typing') {
                // --- Typing Mode ---
                typingContainer.style.display = 'block';
                answerLists.style.display = 'flex';
                document.getElementById('typing-input').value = '';
                document.getElementById('typing-input').focus();

                // Store the correct answers for this question
                currentConstellationMessiers = question.correctAnswers;

                // Reset typed answers tracking
                currentTypedAnswers = { correct: new Set(), incorrect: new Set() };
                updateAnswerLists(); // Clear the display lists

                // Add event listener for real-time validation
                document.getElementById('typing-input').addEventListener('input', handleTypingInput);

                // Add event listener for Enter key submission
                document.getElementById('typing-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        submitTypedAnswer();
                    }
                });

                // --- FIX: Set the question text for typing mode ---
                questionText.textContent = question.question || 'Type the Messier numbers:';

                // Do not generate standard options for typing mode
                return; // Exit early for typing mode
            } else {
                // --- Standard Multiple Choice (Text-based questions) ---
                // Set text for non-image questions
                questionText.textContent = question.question || ''; // Fallback to empty string
            }

            // --- Generate Options for Standard Multiple Choice ---
            // This block runs for image-based questions (falling through from first if)
            // and text-based questions (from the final else)
            // It does NOT run for typing mode (due to the 'return' above)
            if (question.type !== 'constellation-to-messier-typing') { // Extra safety check
                // Standard multiple choice
                // Generate and display options
                const options = getOptions(question.correctAnswer, question.allOptions, 6);
                // Check if options were generated
                if (options && options.length > 0) {
                    options.forEach(option => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.textContent = option;
                        button.onclick = () => checkAnswer(option, question.correctAnswer);
                        optionsContainer.appendChild(button);
                    });
                } else {
                    // Handle case where options couldn't be generated
                    console.error("Failed to generate options for question:", question);
                    questionText.textContent = "Error: Could not load question options.";
                }
            }

            // Update question counter
            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('progress-bar').style.width =
                `${((currentQuestionIndex + 1) / questions.length) * 100}%`;

            // Start question timer if enabled
            if (questionTimerEnabled) {
                startQuestionTimer();
            }
        }
        
        // Handle real-time typing input for Messier typing mode
        function handleTypingInput(e) {
            const input = e.target;
            const value = input.value.trim();
            
            // Only proceed if we have a number
            if (value && /^\d+$/.test(value)) {
                // Check if this Messier number is correct for the constellation
                if (currentConstellationMessiers.includes(value) && 
                    !currentTypedAnswers.correct.has(value)) {
                    // Correct answer not yet typed
                    currentTypedAnswers.correct.add(value);
                    updateAnswerLists();
                    input.value = ''; // Clear input
                    
                    // Check if all correct answers have been found
                    if (currentTypedAnswers.correct.size === currentConstellationMessiers.length) {
                        // All correct answers found, auto-advance after a short delay
                        setTimeout(() => {
                            // Remove event listeners to prevent issues
                            document.getElementById('typing-input').removeEventListener('input', handleTypingInput);
                            processTypingResults(); // Process results and move to next question
                        }, 500); // Slightly longer delay to show the last correct answer
                    }
                }
            }
        }
        
        // Submit manually typed answer (on Enter key or Submit button)
        function submitTypedAnswer() {
            const input = document.getElementById('typing-input');
            const value = input.value.trim();
            
            // Only proceed if we have a number
            if (value && /^\d+$/.test(value)) {
                // If it's not already correct, add to incorrect
                if (!currentConstellationMessiers.includes(value) && 
                    !currentTypedAnswers.incorrect.has(value)) {
                    currentTypedAnswers.incorrect.add(value);
                    updateAnswerLists();
                }
                input.value = ''; // Clear input
            }
        }
        
        // Skip the current typing question
        function skipTypingQuestion() {
            // Disable the skip button to prevent multiple clicks
            document.getElementById('skip-btn').disabled = true;
            
            // Remove event listeners to prevent further input
            document.getElementById('typing-input').removeEventListener('input', handleTypingInput);
            document.getElementById('typing-input').disabled = true;
            
            // Find all correct answers that were NOT typed
            const missedAnswers = currentConstellationMessiers.filter(
                num => !currentTypedAnswers.correct.has(num)
            );
            
            // Create the overlay content
            const skipOverlay = document.getElementById('skip-overlay');
            let overlayContent = '<h3>Missed Messier Objects:</h3><ul class="skip-overlay-list">';
            missedAnswers.forEach(num => {
                overlayContent += `<li>M${num}</li>`;
            });
            overlayContent += '</ul>';
            skipOverlay.innerHTML = overlayContent;
            skipOverlay.style.display = 'block'; // Show the overlay
            
            // Wait 1.5 seconds to show the missed answers, then proceed
            setTimeout(() => {
                skipOverlay.style.display = 'none'; // Hide the overlay
                processTypingResults(); // Process results and move to next question
            }, 1500);
        }
        
        // Update the displayed lists of correct/incorrect answers
        function updateAnswerLists() {
            const correctList = document.getElementById('correct-answers');
            const incorrectList = document.getElementById('incorrect-answers');
            
            // Clear lists
            correctList.innerHTML = '';
            incorrectList.innerHTML = '';
            
            // Populate correct answers
            currentTypedAnswers.correct.forEach(answer => {
                const item = document.createElement('div');
                item.className = 'answer-item';
                item.textContent = `M${answer}`;
                correctList.appendChild(item);
            });
            
            // Populate incorrect answers
            currentTypedAnswers.incorrect.forEach(answer => {
                const item = document.createElement('div');
                item.className = 'answer-item';
                item.textContent = `M${answer}`;
                incorrectList.appendChild(item);
            });
        }
        
        // Process results for typing mode and move to next question
        function processTypingResults() {
            // For typing mode, we'll consider it "correct" if they found all correct answers
            // We can adjust scoring logic here if needed
            const totalCorrectPossible = currentConstellationMessiers.length;
            const foundCorrect = currentTypedAnswers.correct.size;
            
            // Simple scoring: count each correct answer as +1, each incorrect as -0.5
            // But if they skipped, we count it as incorrect
            const scoreAdjustment = foundCorrect - (currentTypedAnswers.incorrect.size * 0.5);
            
            if (scoreAdjustment > 0) {
                correctCount += Math.max(1, Math.floor(scoreAdjustment)); // Ensure at least 1 point for effort
            } else {
                incorrectCount += 1; // Count the question as incorrect if net score is negative or zero
            }
            
            updateStats();
            
            // Re-enable elements for next question
            document.getElementById('skip-btn').disabled = false;
            document.getElementById('typing-input').disabled = false;
            
            // Move to next question
            currentQuestionIndex++;
            showQuestion();
        }
        
        // Check user's answer (for multiple choice)
        function checkAnswer(selected, correct) {
            // Disable all option buttons
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.onclick = null;
            });
            // Stop question timer
            if (questionTimer) {
                clearInterval(questionTimer);
                questionTimer = null;
            }
            // Highlight correct and incorrect answers
            document.querySelectorAll('.option-btn').forEach(btn => {
                if (btn.textContent === correct) {
                    btn.classList.add('correct');
                } else if (btn.textContent === selected && selected !== correct) {
                    btn.classList.add('incorrect');
                }
            });
            // Update stats
            if (selected === correct) {
                correctCount++;
            } else {
                incorrectCount++;
            }
            updateStats();
            // Move to next question after delay
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 500);
        }
        // Update game statistics
        function updateStats() {
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('incorrect-count').textContent = incorrectCount;
            const total = correctCount + incorrectCount;
            const score = total > 0 ? Math.round((correctCount / total) * 100) : 0;
            document.getElementById('score').textContent = `${score}%`;
        }
        // Get a specified number of unique options including the correct answer
        function getOptions(correct, allOptions, count) {
            // Start with the correct answer
            const options = [correct];
            // Create a copy of all options and remove the correct answer
            const shuffledOptions = [...allOptions].filter(opt => opt !== correct).sort(() => Math.random() - 0.5);
            // Add options until we reach the desired count
            while (options.length < count && shuffledOptions.length > 0) {
                const option = shuffledOptions.pop();
                if (!options.includes(option)) {
                    options.push(option);
                }
            }
            // If we still don't have enough options, add placeholders
            while (options.length < count) {
                options.push(`Option ${options.length + 1}`);
            }
            // Shuffle the options
            return options.sort(() => Math.random() - 0.5);
        }
        // Shuffle questions
        function shuffleQuestions() {
            shuffleArray(questions);
            currentQuestionIndex = 0;
            showQuestion();
        }
        // Utility function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        // Start round timer
        function startRoundTimer() {
            if (roundTimer) clearInterval(roundTimer);
            roundTimer = setInterval(() => {
                roundTimeRemaining--;
                const minutes = Math.floor(roundTimeRemaining / 60);
                const seconds = roundTimeRemaining % 60;
                const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                document.getElementById('timer-display').innerHTML = 
                    `Round Time Remaining: <span id="time-remaining">${timeString}</span>`;
                // Add warning class when time is low
                if (roundTimeRemaining <= 30) {
                    document.getElementById('time-remaining').classList.add('timer-warning');
                }
                if (roundTimeRemaining <= 0) {
                    clearInterval(roundTimer);
                    endGame();
                }
            }, 1000);
        }
        // Start question timer
        function startQuestionTimer() {
            if (questionTimer) clearInterval(questionTimer);
            questionTimeRemaining = parseInt(document.getElementById('question-timer-value').value) || 30;
            questionTimer = setInterval(() => {
                questionTimeRemaining--;
                document.getElementById('time-remaining').textContent = 
                    `${questionTimeRemaining}s`;
                // Add warning class when time is low
                if (questionTimeRemaining <= 10) {
                    document.getElementById('time-remaining').classList.add('timer-warning');
                } else {
                    document.getElementById('time-remaining').classList.remove('timer-warning');
                }
                if (questionTimeRemaining <= 0) {
                    clearInterval(questionTimer);
                    // For typing mode, process results when time runs out
                    if (questions[currentQuestionIndex]?.type === 'constellation-to-messier-typing') {
                        document.getElementById('typing-input').removeEventListener('input', handleTypingInput);
                        // When time runs out, treat it like a skip
                        skipTypingQuestion();
                    } else {
                        // Auto-advance to next question for other modes
                        currentQuestionIndex++;
                        showQuestion();
                    }
                }
            }, 1000);
        }
        // End the game
        function endGame() {
            // Clear timers
            if (roundTimer) clearInterval(roundTimer);
            if (questionTimer) clearInterval(questionTimer);
            // Calculate final stats
            const total = correctCount + incorrectCount;
            const score = total > 0 ? Math.round((correctCount / total) * 100) : 0;
            // Update result screen
            document.getElementById('final-correct').textContent = correctCount;
            document.getElementById('final-incorrect').textContent = incorrectCount;
            document.getElementById('final-score').textContent = `${score}%`;
            // Show result screen
            showScreen('result-screen');
        }
        // Restart the game
        function restartGame() {
            showScreen('settings-screen');
        }
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('main-menu');
        });
    </script>
</body>
</html>